name: 📦 Auto Publish to NPM (with Pre-release Tags)

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🚀 Publish to NPM (auto-tag)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION=$(node --input-type=module -e "import pkg from './package.json' assert { type: 'json' }; console.log(pkg.version)")

          # Detect pre-release tag (e.g., awakening)
          if [[ "$VERSION" == *-* ]]; then
            TAG=$(echo "$VERSION" | cut -d '-' -f2 | cut -d '.' -f1)
            echo "🔖 Detected pre-release tag: $TAG"
            npm publish --tag "$TAG"
          else
            echo "✅ Detected stable release"
            npm publish

      - name: ✅ Done
        run: echo "🎉 Published version $VERSION"
